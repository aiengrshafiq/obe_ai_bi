<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OneBullex Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-50 h-screen flex overflow-hidden">

    <aside class="w-64 bg-slate-900 text-white hidden md:flex flex-col flex-shrink-0 transition-all duration-300">
        <div class="p-6 border-b border-slate-800">
            <h1 class="text-xl font-bold tracking-tight text-blue-400">OneBullEx</h1>
            <p class="text-xs text-slate-400 mt-1">Enterprise Data Copilot</p>
        </div>
        
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto no-scrollbar">
            <button onclick="location.reload()" class="w-full flex items-center space-x-3 bg-slate-800 hover:bg-slate-700 text-white p-3 rounded-lg transition-colors border border-slate-700">
                <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                <span class="font-medium text-sm">New Chat</span>
            </button>
            <div class="pt-6 pb-2 text-xs font-semibold text-slate-500 uppercase tracking-wider">Suggested Queries</div>
            <button onclick="fillInput('Show top 10 large deposits')" class="text-left w-full group flex items-center space-x-3 p-2 rounded-lg hover:bg-slate-800 transition">
                <span class="bg-slate-800 text-slate-400 group-hover:text-blue-400 w-6 h-6 flex items-center justify-center rounded text-xs">üí∞</span>
                <span class="text-slate-300 text-sm group-hover:text-white">Top Deposits</span>
            </button>
            <button onclick="fillInput('Count trades by market type')" class="text-left w-full group flex items-center space-x-3 p-2 rounded-lg hover:bg-slate-800 transition">
                <span class="bg-slate-800 text-slate-400 group-hover:text-green-400 w-6 h-6 flex items-center justify-center rounded text-xs">üìä</span>
                <span class="text-slate-300 text-sm group-hover:text-white">Trade Counts</span>
            </button>
            <button onclick="location.href='/admin/logs'"
                    class="w-full group flex items-center space-x-3 p-3 rounded-lg bg-slate-800 hover:bg-slate-700 transition-colors border border-slate-700">
                <span class="bg-slate-900 text-slate-400 group-hover:text-purple-400 w-6 h-6 flex items-center justify-center rounded">
                    üìú
                </span>
                <span class="text-slate-300 text-sm font-medium group-hover:text-white">
                    System Logs
                </span>
            </button>

        </nav>
        <div class="p-4 border-t border-slate-800 mt-auto">
            <div class="flex items-center gap-3 mb-3">
                <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white text-xs font-bold" id="user-avatar">U</div>
                <div class="text-sm font-medium text-slate-300" id="username-display">User</div>
            </div>
            <button onclick="logout()" class="w-full text-xs text-red-400 hover:text-red-300 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                Sign Out
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative bg-white h-full w-full">
        <header class="h-16 flex-shrink-0 border-b border-gray-100 flex items-center justify-between px-6 bg-white z-10">
            <div class="flex items-center gap-2">
                <h2 class="text-lg font-semibold text-gray-800">OneBullEx Assistant</h2>
                <span class="px-2 py-0.5 rounded text-[10px] font-medium bg-blue-50 text-blue-600 border border-blue-100">BETA</span>
            </div>
            <div class="text-xs text-gray-400 font-mono">Model: Qwen-3-Coder-Plus</div>
        </header>

        <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth">
            <div class="flex space-x-4 max-w-3xl mx-auto">
                <div class="w-8 h-8 rounded-full bg-blue-600 flex-shrink-0 flex items-center justify-center text-white text-xs shadow-sm">AI</div>
                <div class="bg-white border border-gray-100 p-6 rounded-2xl rounded-tl-none shadow-sm w-full">
                    <h3 class="font-medium text-gray-900 mb-2">Hello! I'm connected to the Data Warehouse.</h3>
                    <p class="text-sm text-gray-600">Ask me about Deposits, Trades, or User Positions.</p>
                </div>
            </div>
            <div id="scroll-anchor" class="h-32"></div> 
        </div>

        <div class="absolute bottom-0 left-0 w-full bg-white/95 backdrop-blur border-t border-gray-100 p-4 pb-6 z-20">
            <div class="max-w-3xl mx-auto relative">
                <div class="relative shadow-lg rounded-2xl">
                    <input type="text" id="user-input" 
                        class="w-full bg-white border border-gray-200 text-gray-800 placeholder-gray-400 text-sm rounded-2xl focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 block p-4 pr-14 transition-all" 
                        placeholder="Ask a question about your data..."
                        onkeypress="handleKeyPress(event)">
                    <button onclick="sendMessage()" class="absolute right-2 top-2 p-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl transition-colors duration-200 group">
                        <svg class="w-5 h-5 transform group-hover:translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </main>
    <script>
    // Load Username on Startup
    document.addEventListener('DOMContentLoaded', () => {
        const user = localStorage.getItem('username');
        if(user) {
            document.getElementById('username-display').innerText = user;
            document.getElementById('user-avatar').innerText = user.substring(0,2).toUpperCase();
        } else {
            // Redirect if no session (optional, serves as double check)
            if(!localStorage.getItem('access_token')) window.location.href = "/login";
        }
    });

    function logout() {
        localStorage.removeItem('access_token');
        localStorage.removeItem('username');
        window.location.href = "/login";
    }
</script>
    <script>
        // Store conversation history in memory
        let chatHistory = [];
        window.queryResults = {};
        
        function fillInput(text) {
            const input = document.getElementById('user-input');
            input.value = text;
            input.focus();
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') sendMessage();
        }

        async function sendMessage() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = "/login";
                return;
            }
            const input = document.getElementById('user-input');
            const container = document.getElementById('chat-container');
            const anchor = document.getElementById('scroll-anchor');
            const text = input.value.trim();
            if (!text) return;

            // 1. Add User Message
            const userMsg = document.createElement('div');
            userMsg.className = "flex justify-end space-x-4 max-w-3xl mx-auto animate-fade-in-up";
            userMsg.innerHTML = `<div class="bg-blue-600 text-white px-5 py-3 rounded-2xl rounded-tr-none shadow-md max-w-xl text-sm leading-relaxed">${text}</div>`;
            container.insertBefore(userMsg, anchor);
            
            input.value = '';
            scrollToBottom();

            // 2. Add Loading
            const loadingId = 'loading-' + Date.now();
            const loadingMsg = document.createElement('div');
            loadingMsg.id = loadingId;
            loadingMsg.className = "flex space-x-4 max-w-3xl mx-auto animate-fade-in-up";
            loadingMsg.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-blue-600 flex-shrink-0 flex items-center justify-center text-white text-xs shadow-sm">AI</div>
                <div class="bg-white border border-gray-100 p-4 rounded-2xl rounded-tl-none shadow-sm flex items-center gap-3">
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                        <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    </div>
                    <span class="text-xs text-gray-400 font-medium">Generating SQL...</span>
                </div>`;
            container.insertBefore(loadingMsg, anchor);
            scrollToBottom();

            try {
                // SEND REQUEST
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        message: text,
                        history: chatHistory 
                    })
                });

                // Handle 401 (Expired Token)
                if (res.status === 401) {
                    localStorage.removeItem('access_token');
                    window.location.href = "/login";
                    return;
                }

                const data = await res.json();
                
                document.getElementById(loadingId).remove();

                // SAVE TO HISTORY (Client Side)
                chatHistory.push({ role: "user", content: text });
                if (data.sql) {
                    // It was a query
                    chatHistory.push({ role: "assistant", content: data.sql });
                } else if (data.type === 'text' && data.message) {
                    // CRITICAL FIX: Save the Clarification/Text to history
                    // This ensures the AI remembers it asked "By volume or count?"
                    chatHistory.push({ role: "assistant", content: data.message });
                }

                if (chatHistory.length > 6) chatHistory = chatHistory.slice(-6);

                // 3. Render Logic
                let contentHTML = '';
                
                if (data.type === 'error') {
                    contentHTML = `<div class="text-red-600 font-medium text-sm">‚ö†Ô∏è ${data.message}</div>`;

                } else if (data.type === 'text') {
                    // --- NEW: HANDLE CLARIFICATION / TEXT RESPONSE ---
                    contentHTML = `<div class="text-gray-800 text-sm leading-relaxed">${data.message}</div>`;

                } else {
                    // --- 1. SAVE DATA FOR EXPORT ---
                    const resultId = Date.now();
                    if (data.data && data.data.length > 0) {
                        window.queryResults[resultId] = data.data;
                    }

                    // Thought Process
                    contentHTML += `<div class="text-xs text-gray-500 mb-2 italic">Thinking: ${data.thought}</div>`;
                    
                    // --- 2. HEADER: SQL + EXPORT BUTTON ---
                    contentHTML += `
                        <div class="flex justify-between items-end mb-4 group">
                            <details class="w-full">
                                <summary class="text-xs text-blue-600 cursor-pointer hover:underline list-none select-none">
                                    <span class="mr-1">‚ñ∂</span> View SQL & Tools
                                </summary>
                                <div class="mt-2 border border-gray-200 rounded-lg bg-gray-50 p-2">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-xs font-semibold text-gray-500 uppercase">SQL Editor</span>
                                        <button onclick="runCustomSQL(this)" class="bg-blue-600 hover:bg-blue-700 text-white text-[10px] px-3 py-1 rounded transition-colors">Run Fix</button>
                                    </div>
                                    <textarea class="w-full bg-slate-900 text-green-400 font-mono text-xs p-3 rounded h-24 focus:ring-2 focus:ring-blue-500 outline-none resize-y" spellcheck="false">${data.sql}</textarea>
                                </div>
                            </details>
                            
                            ${(data.data && data.data.length > 0) ? `
                                <button onclick="exportToCSV(${resultId})" class="ml-2 flex items-center gap-1 text-xs font-medium text-gray-500 hover:text-blue-600 bg-white border border-gray-200 hover:border-blue-300 px-3 py-1.5 rounded-lg shadow-sm transition-all whitespace-nowrap">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    Export CSV
                                </button>
                            ` : ''}
                        </div>`;

                    // Smart Insight 
                    if (data.insight) {
                        contentHTML += `
                            <div class="mb-4 bg-indigo-50 border-l-4 border-indigo-500 p-3 rounded-r flex items-start gap-3">
                                <div class="text-indigo-500 mt-0.5">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                </div>
                                <div>
                                    <div class="text-[10px] font-bold text-indigo-400 uppercase tracking-wide">AI Insight</div>
                                    <div class="text-sm text-indigo-900 font-medium leading-snug">${data.insight}</div>
                                </div>
                            </div>`;
                    }

                    // --- VISUALIZATION LOGIC ---
                    // Handle Vanna's 'plotly' signal
                    if (data.visual_type === 'plotly') {
                        // Heuristic: Check if data implies time-series
                        if (data.data && data.data.length > 0) {
                            const keys = Object.keys(data.data[0]);
                            const hasDate = keys.some(k => k.toLowerCase().includes('date') || k.toLowerCase().includes('ds'));
                            data.visual_type = hasDate ? 'line' : 'bar';
                        }
                    }

                    let visualType = data.visual_type;
                    if (data.data && data.data.length > 1 && visualType === 'kpi') {
                        visualType = 'table';
                    }

                    if (visualType === 'kpi' && data.data.length > 0) {
                        let val = data.data[0][Object.keys(data.data[0])[0]];
                        if (typeof val === 'number') val = val.toLocaleString();
                        contentHTML += `
                            <div class="p-6 bg-gradient-to-br from-blue-50 to-white border border-blue-100 rounded-xl text-center shadow-sm">
                                <div class="text-gray-500 text-sm uppercase tracking-wide mb-1">${data.title || 'Result'}</div>
                                <div class="text-4xl font-bold text-blue-900">${val}</div>
                            </div>`;
                        
                    } else if (['bar', 'line', 'pie'].includes(visualType) && data.data.length > 0) {
                        const chartId = 'chart-' + Date.now();
                        contentHTML += `
                            <div class="border border-gray-200 rounded-xl p-4 bg-white shadow-sm">
                                <h4 class="text-sm font-semibold text-gray-700 mb-4 text-center">${data.title || 'Analysis Chart'}</h4>
                                <div id="${chartId}" style="width: 100%; height: 350px;"></div>
                            </div>`;
                        setTimeout(() => renderChart(chartId, visualType, data.data, data.x_axis, data.y_axis), 100);
                        
                    } else {
                        contentHTML += generateTableHTML(data.data);
                    }
                }

                const botMsg = document.createElement('div');
                botMsg.className = "flex space-x-4 max-w-3xl mx-auto animate-fade-in-up";
                botMsg.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-blue-600 flex-shrink-0 flex items-center justify-center text-white text-xs shadow-sm mt-1">AI</div>
                    <div class="bg-white border border-gray-100 p-6 rounded-2xl rounded-tl-none shadow-sm w-full">${contentHTML}</div>`;
                
                container.insertBefore(botMsg, anchor);
                scrollToBottom();

            } catch (e) {
                console.error(e);
                if(document.getElementById(loadingId)) document.getElementById(loadingId).remove();
            }
        }

        async function runCustomSQL(btn) {
            const token = localStorage.getItem('access_token');
            // Get SQL from textarea
            const sqlEditorDiv = btn.closest('.bg-gray-50');
            const textarea = sqlEditorDiv.querySelector('textarea');
            const sql = textarea.value.trim();
            
            // Navigate DOM
            const detailsElement = sqlEditorDiv.parentElement; 
            const headerWrapper = detailsElement.parentElement; 
            const resultArea = headerWrapper.parentElement; 

            if (!sql) return;

            // Loading State
            const originalText = btn.innerText;
            btn.innerText = "Running...";
            btn.disabled = true;
            btn.classList.add('opacity-75');

            try {
                // Call Backend
                const res = await fetch('/api/run_custom_sql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token // Send Token
                    },
                    body: JSON.stringify({sql_query: sql})
                });
                const data = await res.json();

                btn.innerText = originalText;
                btn.disabled = false;
                btn.classList.remove('opacity-75');

                if (data.type === 'error') {
                    alert("SQL Error: " + data.message);
                    return;
                }

                // Save for Export
                const resultId = Date.now();
                if (data.data && data.data.length > 0) {
                    window.queryResults[resultId] = data.data;
                }

                // Update Export Button
                const oldExportBtn = headerWrapper.querySelector('button.ml-2');
                if (oldExportBtn) oldExportBtn.remove();

                if (data.data && data.data.length > 0) {
                    const exportBtn = document.createElement('button');
                    exportBtn.className = "ml-2 flex items-center gap-1 text-xs font-medium text-gray-500 hover:text-blue-600 bg-white border border-gray-200 hover:border-blue-300 px-3 py-1.5 rounded-lg shadow-sm transition-all whitespace-nowrap";
                    exportBtn.onclick = function() { exportToCSV(resultId); };
                    exportBtn.innerHTML = `
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Export CSV`;
                    headerWrapper.appendChild(exportBtn);
                }

                // Render New Result
                const oldChart = resultArea.querySelector('.border.rounded-xl');
                if(oldChart) oldChart.remove();
                
                const oldTable = resultArea.querySelector('.overflow-x-auto.border'); 
                if(oldTable) oldTable.remove();
                
                const oldError = resultArea.querySelector('.text-red-600');
                if(oldError) oldError.remove();

                const resultDiv = document.createElement('div');
                
                // If Vanna/Backend sends 'plotly' or chart types
                if (data.visual_type === 'plotly') {
                     const keys = Object.keys(data.data[0]);
                     const hasDate = keys.some(k => k.toLowerCase().includes('date') || k.toLowerCase().includes('ds'));
                     data.visual_type = hasDate ? 'line' : 'bar';
                }

                if (['bar', 'line', 'pie'].includes(data.visual_type) && data.data.length > 0) {
                    const chartId = 'chart-' + Date.now();
                    resultDiv.innerHTML = `
                        <div class="border border-gray-200 rounded-xl p-4 bg-white shadow-sm mt-4">
                            <h4 class="text-sm font-semibold text-gray-700 mb-4 text-center">${data.title || 'Result Chart'}</h4>
                            <div id="${chartId}" style="width: 100%; height: 350px;"></div>
                        </div>`;
                    resultArea.appendChild(resultDiv);
                    renderChart(chartId, data.visual_type, data.data, null, null);
                } else {
                    resultDiv.innerHTML = generateTableHTML(data.data);
                    resultDiv.classList.add('mt-4');
                    resultArea.appendChild(resultDiv);
                }

            } catch (e) {
                console.error(e);
                alert("Execution failed: " + e);
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function scrollToBottom() {
            const anchor = document.getElementById('scroll-anchor');
            anchor.scrollIntoView({ behavior: 'smooth' });
        }

        function renderChart(containerId, type, data, xKey, yKey) {
            const chartDom = document.getElementById(containerId);
            if (!chartDom) return;
            const myChart = echarts.init(chartDom);
            
            if (!xKey || !yKey) {
                const keys = Object.keys(data[0]);
                xKey = keys.find(k => k.toLowerCase().includes('date') || k.toLowerCase().includes('name') || k.toLowerCase().includes('ds')) || keys[0];
                yKey = keys.find(k => k !== xKey) || keys[1];
            }

            const labels = data.map(i => i[xKey]);
            const values = data.map(i => i[yKey]);

            const option = {
                tooltip: { trigger: 'axis' },
                grid: { left: '3%', right: '4%', bottom: '10%', top: '15%', containLabel: true },
                xAxis: { type: 'category', data: labels, axisLabel: { rotate: 45, fontSize: 10 } },
                yAxis: { type: 'value' },
                series: [{
                    data: values, type: type, smooth: true, itemStyle: { color: '#2563eb' },
                    areaStyle: type === 'line' ? { opacity: 0.1, color: '#3b82f6' } : null
                }]
            };
            if (type === 'pie') {
                option.xAxis = null; option.yAxis = null;
                option.series = [{
                    type: 'pie', radius: ['40%', '70%'], itemStyle: { borderRadius: 5 },
                    data: data.map(i => ({ value: i[yKey], name: i[xKey] }))
                }];
            }
            myChart.setOption(option);
            window.addEventListener('resize', () => myChart.resize());
        }

        function generateTableHTML(data) {
            if (!data || data.length === 0) return '<div class="text-gray-500 italic">No data found.</div>';
            let html = '<div class="overflow-x-auto border border-gray-200 rounded-lg"><table class="min-w-full text-sm divide-y divide-gray-200"><thead class="bg-gray-50"><tr>';
            Object.keys(data[0]).forEach(k => html += `<th class="px-4 py-3 text-left font-semibold text-gray-600 text-xs uppercase">${k}</th>`);
            html += '</tr></thead><tbody class="divide-y divide-gray-100 bg-white">';
            data.slice(0, 10).forEach(row => {
                html += '<tr class="hover:bg-blue-50/50">';
                Object.values(row).forEach(v => {
                    let val = (typeof v === 'number' && v % 1 !== 0) ? v.toFixed(4) : v;
                    html += `<td class="px-4 py-3 text-gray-700 whitespace-nowrap font-mono text-xs">${val}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            return html;
        }

        function exportToCSV(resultId) {
            const data = window.queryResults[resultId];
            if (!data || data.length === 0) {
                alert("No data to export.");
                return;
            }
            const headers = Object.keys(data[0]);
            const csvRows = [];
            csvRows.push(headers.join(','));
            
            for (const row of data) {
                const values = headers.map(header => {
                    const val = row[header];
                    const escaped = ('' + (val ?? '')).replace(/"/g, '\\"');
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            }
            
            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', `onebullex_export_${resultId}.csv`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>