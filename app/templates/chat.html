<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OneBullEx Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in-up { animation: fadeInUp 0.4s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        /* Markdown Tables */
        .prose table { font-size: 0.875rem; width: 100%; border-collapse: collapse; }
        .prose th { background: #f1f5f9; padding: 8px; text-align: left; font-weight: 600; color: #475569; }
        .prose td { border-bottom: 1px solid #e2e8f0; padding: 8px; color: #334155; }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <div class="md:hidden fixed w-full bg-slate-900 text-white z-50 flex items-center justify-between px-4 py-3 shadow-md">
        <span class="font-bold text-lg text-blue-400">OneBullEx</span>
        <button onclick="toggleSidebar()" class="text-gray-300 hover:text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
        </button>
    </div>

    <aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-slate-900 text-white transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 z-40 flex flex-col shadow-xl">
        <div class="p-6 border-b border-slate-800 hidden md:block">
            <h1 class="text-xl font-bold tracking-tight text-blue-400">OneBullEx</h1>
            <p class="text-xs text-slate-400 mt-1">Enterprise Data Copilot</p>
        </div>
        
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto no-scrollbar pt-16 md:pt-4">
            <button onclick="location.reload()" class="w-full flex items-center space-x-3 bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg transition-all shadow-md group">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                <span class="font-medium text-sm">New Analysis</span>
            </button>

            <div class="pt-6 pb-2 text-xs font-bold text-slate-500 uppercase tracking-wider px-2">Quick Queries</div>
            
            <button onclick="fillInput('Show top 10 large deposits')" class="w-full text-left flex items-center space-x-3 p-2.5 rounded-lg hover:bg-slate-800 transition-colors text-slate-300 hover:text-white">
                <span class="text-lg">üí∞</span>
                <span class="text-sm">Large Deposits</span>
            </button>
            <button onclick="fillInput('User registration trend last 7 days')" class="w-full text-left flex items-center space-x-3 p-2.5 rounded-lg hover:bg-slate-800 transition-colors text-slate-300 hover:text-white">
                <span class="text-lg">üìà</span>
                <span class="text-sm">User Growth</span>
            </button>
            <button onclick="fillInput('Show fraud risk summary')" class="w-full text-left flex items-center space-x-3 p-2.5 rounded-lg hover:bg-slate-800 transition-colors text-slate-300 hover:text-white">
                <span class="text-lg">üõ°Ô∏è</span>
                <span class="text-sm">Risk Analysis</span>
            </button>

            <div class="pt-6 pb-2 text-xs font-bold text-slate-500 uppercase tracking-wider px-2">Tools</div>
            <a href="/admin/logs" class="flex items-center space-x-3 p-2.5 rounded-lg hover:bg-slate-800 text-slate-300 hover:text-white transition-colors">
                <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                <span class="text-sm">System Logs</span>
            </a>
        </nav>

        <div class="p-4 border-t border-slate-800 bg-slate-900">
            <div class="flex items-center gap-3 mb-3">
                <div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-indigo-500 flex items-center justify-center text-white text-xs font-bold shadow-lg" id="user-avatar">U</div>
                <div class="text-sm font-medium text-white truncate" id="username-display">User</div>
            </div>
            <button onclick="logout()" class="w-full text-xs text-red-400 hover:text-red-300 hover:bg-slate-800 py-2 rounded flex items-center justify-center gap-2 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                Sign Out
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative w-full bg-white h-full">
        <header class="hidden md:flex h-16 border-b border-gray-100 items-center justify-between px-8 bg-white/80 backdrop-blur z-10 sticky top-0">
            <div class="flex items-center gap-3">
                <h2 class="text-lg font-semibold text-slate-800">Intelligence Engine</h2>
                <span class="px-2 py-0.5 rounded-full text-[10px] font-bold bg-indigo-50 text-indigo-600 border border-indigo-100 tracking-wide">BETA v2.0</span>
            </div>
            <div class="text-xs text-slate-400 font-mono bg-slate-50 px-2 py-1 rounded border border-slate-100">
                Connected: Data Warehouse (Live)
            </div>
        </header>

        <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth pb-32">
            <div class="flex space-x-4 max-w-4xl mx-auto fade-in-up">
                <div class="w-8 h-8 rounded-full bg-blue-600 flex-shrink-0 flex items-center justify-center text-white text-xs shadow-md mt-1">AI</div>
                <div class="bg-white border border-gray-200 p-6 rounded-2xl rounded-tl-none shadow-sm w-full">
                    <h3 class="font-semibold text-gray-900 mb-2 text-lg">Ready to analyze.</h3>
                    <p class="text-gray-600 leading-relaxed mb-4">I can query all data cubes including User Profiles, Trading Activity, Financial Audits, and Risk Logs.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <button onclick="fillInput('Show total trading volume by day for last week')" class="text-left text-sm p-3 bg-gray-50 hover:bg-blue-50 border border-gray-100 hover:border-blue-200 rounded-lg transition-colors text-gray-600 hover:text-blue-700">
                            üìà Show daily volume trend
                        </button>
                        <button onclick="fillInput('List users with high risk score > 0.8')" class="text-left text-sm p-3 bg-gray-50 hover:bg-blue-50 border border-gray-100 hover:border-blue-200 rounded-lg transition-colors text-gray-600 hover:text-blue-700">
                            üö® Find high-risk users
                        </button>
                    </div>
                </div>
            </div>
            <div id="scroll-anchor"></div>
        </div>

        <div class="absolute bottom-0 left-0 w-full bg-white/90 backdrop-blur-md border-t border-gray-200 p-4 md:p-6 z-20">
            <div class="max-w-4xl mx-auto relative group">
                <div class="absolute inset-0 bg-gradient-to-r from-blue-500 to-indigo-500 rounded-2xl opacity-0 group-focus-within:opacity-10 transition-opacity duration-300 -m-1"></div>
                <div class="relative flex items-center bg-white border border-gray-300 rounded-2xl shadow-sm focus-within:shadow-lg focus-within:border-blue-500 transition-all">
                    <input type="text" id="user-input" 
                        class="w-full bg-transparent text-gray-800 placeholder-gray-400 text-base rounded-2xl px-5 py-4 focus:outline-none" 
                        placeholder="Ask a question about your data..."
                        autocomplete="off"
                        onkeypress="handleKeyPress(event)">
                    <button onclick="sendMessage()" class="mr-2 p-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-xl transition-all hover:scale-105 shadow-md disabled:opacity-50 disabled:hover:scale-100" id="send-btn">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                    </button>
                </div>
                <div class="text-center mt-2">
                    <p class="text-[10px] text-gray-400">AI can make mistakes. Verify critical financial data.</p>
                </div>
            </div>
        </div>
    </main>

    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 hidden z-30 md:hidden backdrop-blur-sm"></div>

    <script>
        // --- Session Management ---
        const token = localStorage.getItem('access_token');
        const username = localStorage.getItem('username');

        if (!token) window.location.href = "/login";
        
        if (username) {
            document.getElementById('username-display').innerText = username;
            document.getElementById('user-avatar').innerText = username.substring(0,2).toUpperCase();
        }

        function logout() {
            localStorage.clear();
            window.location.href = "/login";
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        // --- Chat Logic ---
        let chatHistory = [];
        window.queryResults = {};

        function fillInput(text) {
            const input = document.getElementById('user-input');
            input.value = text;
            input.focus();
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const btn = document.getElementById('send-btn');
            const text = input.value.trim();
            if (!text) return;

            // UI Updates
            input.value = '';
            input.disabled = true;
            btn.disabled = true;
            
            appendUserMessage(text);
            const loadingId = appendLoader();

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ message: text, history: chatHistory })
                });

                if (res.status === 401) { logout(); return; }

                const data = await res.json();
                document.getElementById(loadingId).remove();

                // Update History
                chatHistory.push({ role: "user", content: text });
                if (data.sql) chatHistory.push({ role: "assistant", content: data.sql });
                else if (data.message) chatHistory.push({ role: "assistant", content: data.message });
                
                if (chatHistory.length > 8) chatHistory = chatHistory.slice(-8);

                renderResponse(data);

            } catch (err) {
                document.getElementById(loadingId).remove();
                appendSystemMessage("Network Error: " + err.message, "text-red-500");
            } finally {
                input.disabled = false;
                btn.disabled = false;
                input.focus();
            }
        }

        // --- Renderers ---

        function appendUserMessage(text) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = "flex justify-end space-x-4 max-w-4xl mx-auto fade-in-up mb-6";
            div.innerHTML = `<div class="bg-blue-600 text-white px-6 py-3.5 rounded-2xl rounded-tr-none shadow-md max-w-2xl text-sm leading-relaxed">${text}</div>`;
            container.insertBefore(div, document.getElementById('scroll-anchor'));
            scrollToBottom();
        }

        function appendLoader() {
            const id = 'loader-' + Date.now();
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex space-x-4 max-w-4xl mx-auto fade-in-up mb-6";
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-blue-600 flex-shrink-0 flex items-center justify-center text-white text-xs shadow-sm">AI</div>
                <div class="bg-white border border-gray-200 p-4 rounded-2xl rounded-tl-none shadow-sm flex items-center gap-3">
                    <span class="relative flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-blue-500"></span></span>
                    <span class="text-xs text-gray-500 font-medium">Analyzing data...</span>
                </div>`;
            container.insertBefore(div, document.getElementById('scroll-anchor'));
            scrollToBottom();
            return id;
        }

        function appendSystemMessage(text, colorClass = "text-gray-800") {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = "flex space-x-4 max-w-4xl mx-auto fade-in-up mb-6";
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-red-500 flex-shrink-0 flex items-center justify-center text-white text-xs shadow-sm">!</div>
                <div class="bg-white border border-red-100 p-4 rounded-2xl rounded-tl-none shadow-sm text-sm ${colorClass}">${text}</div>`;
            container.insertBefore(div, document.getElementById('scroll-anchor'));
            scrollToBottom();
        }

        function renderResponse(data) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = "flex space-x-4 max-w-4xl mx-auto fade-in-up mb-8";
            
            // 1. Build Content
            let content = '';
            
            if (data.type === 'error') {
                content = `<div class="text-red-600 font-medium bg-red-50 p-3 rounded-lg border border-red-100">‚ö†Ô∏è ${data.message}</div>`;
            } 
            else if (data.type === 'text') {
                content = `<div class="text-slate-700 text-sm leading-7 prose">${data.message}</div>`;
            } 
            else {
                // Success Data Response
                const resultId = Date.now();
                if(data.data) window.queryResults[resultId] = data.data;

                // Thought Header
                content += `<div class="flex items-center gap-2 mb-3 text-xs text-slate-400 font-mono bg-slate-50 p-2 rounded border border-slate-100 w-fit">
                    <span>üß† Logic:</span> <span class="text-slate-600">${data.thought || 'Processed'}</span>
                </div>`;

                // SQL Toggle
                content += `
                    <details class="group mb-4">
                        <summary class="text-xs text-blue-600 cursor-pointer hover:text-blue-800 font-medium flex items-center gap-1 select-none">
                            <svg class="w-3 h-3 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            View SQL Query
                        </summary>
                        <div class="mt-2 relative">
                            <textarea class="w-full bg-slate-900 text-emerald-400 font-mono text-xs p-3 rounded-lg h-24 focus:ring-1 focus:ring-blue-500 outline-none resize-y shadow-inner border border-slate-700" spellcheck="false" id="sql-${resultId}">${data.sql}</textarea>
                            <div class="absolute top-2 right-2 flex gap-2">
                                <button onclick="runCustomSQL(${resultId})" class="bg-blue-600 hover:bg-blue-700 text-white text-[10px] px-2 py-1 rounded shadow transition-colors">Run Edit</button>
                            </div>
                        </div>
                    </details>`;

                // Visualization Area
                if (data.visual_type === 'plotly' && data.plotly_code) {
                    const chartId = 'viz-' + resultId;
                    content += `
                        <div class="bg-white border border-slate-200 rounded-xl p-1 shadow-sm">
                            <div id="${chartId}" style="width: 100%; height: 400px;" class="rounded-lg overflow-hidden"></div>
                        </div>`;
                    
                    // Render Plotly after DOM update
                    setTimeout(() => {
                        Plotly.newPlot(chartId, data.plotly_code.data, data.plotly_code.layout, {responsive: true, displayModeBar: false});
                    }, 50);

                } else if (data.visual_type === 'table' || (data.data && data.data.length > 0)) {
                    content += generateTable(data.data);
                } else {
                    content += `<div class="text-slate-500 italic p-4 bg-gray-50 rounded-lg text-center">No data found for this query.</div>`;
                }

                // Actions Footer
                if (data.data && data.data.length > 0) {
                    content += `
                        <div class="mt-4 flex gap-2 justify-end">
                            <button onclick="exportCSV(${resultId})" class="text-xs flex items-center gap-1 text-slate-500 hover:text-blue-600 bg-white border border-slate-200 px-3 py-1.5 rounded-md hover:shadow-sm transition-all">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                Download CSV
                            </button>
                        </div>`;
                }
            }

            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-blue-600 flex-shrink-0 flex items-center justify-center text-white text-xs shadow-md mt-1">AI</div>
                <div class="bg-white border border-gray-200 p-5 rounded-2xl rounded-tl-none shadow-sm w-full overflow-hidden">${content}</div>`;
            
            container.insertBefore(div, document.getElementById('scroll-anchor'));
            scrollToBottom();
        }

        // --- Helpers ---

        function generateTable(data) {
            if (!data || data.length === 0) return '';
            const headers = Object.keys(data[0]);
            let rows = '';
            data.slice(0, 10).forEach(row => {
                rows += `<tr class="hover:bg-blue-50/30 transition-colors">` + 
                        Object.values(row).map(v => `<td class="px-4 py-3 whitespace-nowrap text-slate-600 font-mono text-xs border-b border-slate-100">${(typeof v==='number' && !Number.isInteger(v)) ? v.toFixed(2) : v}</td>`).join('') + 
                        `</tr>`;
            });
            
            return `
                <div class="overflow-x-auto rounded-lg border border-slate-200 shadow-sm mt-2">
                    <table class="min-w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 font-semibold uppercase text-[10px] tracking-wider">
                            <tr>${headers.map(h => `<th class="px-4 py-3 border-b border-slate-200">${h}</th>`).join('')}</tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-slate-100">${rows}</tbody>
                    </table>
                    ${data.length > 10 ? `<div class="p-2 text-center text-xs text-slate-400 bg-slate-50 border-t border-slate-100">Showing first 10 of ${data.length} rows</div>` : ''}
                </div>`;
        }

        function scrollToBottom() {
            document.getElementById('scroll-anchor').scrollIntoView({ behavior: 'smooth' });
        }

        function exportCSV(id) {
            const data = window.queryResults[id];
            if(!data) return;
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(h => `"${String(row[h]).replace(/"/g, '""')}"`).join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `analysis_export_${Date.now()}.csv`;
            link.click();
        }

        async function runCustomSQL(id) {
            const textarea = document.getElementById(`sql-${id}`);
            const sql = textarea.value.trim();
            if(!sql) return;
            
            fillInput("Running custom SQL..."); // Visual Feedback
            // Note: In a real app, you might want to call the API directly here instead of using the main chat flow
            // But for simplicity, we treat it as a new "user request" which might get messy.
            // Better to re-use the sendMessage logic logic but targeted.
            
            // For now, let's just trigger the main API with a special flag or just use the separate endpoint manually:
            try {
                const res = await fetch('/api/run_custom_sql', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ sql_query: sql })
                });
                const data = await res.json();
                renderResponse(data);
            } catch(e) {
                alert("Error: " + e);
            }
        }
    </script>
</body>
</html>